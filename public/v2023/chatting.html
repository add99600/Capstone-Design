<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <title>농밀</title>
    <link rel="stylesheet" type="text/css" href="../../static/css/chatting-style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

</head>

<body>
<div class="container">
    <div class="left">
        <div class="header" style="text-align: left; padding-left: 20px">
            채팅방 목록
        </div>
        <div class="chatting-list">

{#            <div class="chatting-room">#}
{#                <div class="details">#}
{#                    <div class="name">[구매자] 심희준</div>#}
{#                    <div class="message">거 당 얼마</div>#}
{#                </div>#}
{#                <div class="time">Yesterday</div>#}
{#            </div>#}

        </div>
    </div>

    <div class="right">
        <div class="header" style="padding-left: 20px">
            채팅방
        </div>
        <div class="chat-content" style="height:440px; overflow-x: hidden">
            <div class="chat ch1">
                <div class="icon"><i class="fa-solid fa-user"></i></div>
                <div class="textbox">왼쪽의 채팅방을 선택해 주세요</div>
            </div>
        </div>
        <div class="input-group" style="width: 100%; height: 60px;">
            <div style="text-align: center; bottom: 0;">
                <input class="form-control" id="chat-input" style="width: 85%; height: 50px;">
                <button class="btn btn-secondary" id="send" style="width: 10%; height: 50px;">전송</button>
            </div>
        </div>
    </div>
</div>
</body>

<script>
    var firebaseConfig = {
        apiKey: "AIzaSyCunQjLi23bBAybA97IFMaIrXUwuJSV8mM",
        authDomain: "wepdo-7bed1.firebaseapp.com",
        databaseURL: "https://wepdo-7bed1-default-rtdb.firebaseio.com",
        projectId: "wepdo-7bed1",
        storageBucket: "wepdo-7bed1.appspot.com",
        messagingSenderId: "204948006692",
        appId: "1:204948006692:web:bbb863d7032ddbbf64b5b1",
        measurementId: "G-7NQSDSFC61"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage();
    var my_uid = JSON.parse(localStorage.getItem('user')).uid;
    var chatroom_id
    var bring = new URLSearchParams(window.location.search);
    var my_img
    var whoValue

    db.collection('chat').where('who', 'array-contains', my_uid).get().then((result) => {
      result.docs.forEach((doc) => {
        whoValue = doc.data().who;
        console.log(whoValue);
      });
    });


    db.collection('chat').where('who', 'array-contains', bring.get('id')).get().then((result) => {
        result.forEach((doc) => {
        var chatroom = `
                        <div class="chatting-room" data-chat-id="${doc.id}">
                           <img src="${doc.data().img}">
                            <div class="details">
                              <a href="#" class="name">${doc.data().product}</a>
                              <div class="message">${doc.data().name}</div>
                           </div>
                        </div>`;
        $('.chatting-list').append(chatroom);
      });

      $('.chatting-room').click(function (e) {
          chatroom_id = $(this).data('chat-id');

          e.stopImmediatePropagation();

          console.log('Chatroom ID:', chatroom_id);

          db.collection('chat').doc(chatroom_id).collection('message').orderBy('data').onSnapshot((result)=>{
              $('.chat-content').html('');
              result.forEach((a)=>{
                    var message = '';
                    if (a.data().uid === my_uid) {
                        db.collection('user').doc(my_uid).get().then((result)=>{
                            my_img = result.data().이미지;
                        });
                        message = `
                            <div class="chat ch2">
                                <div class="icon"><i class="fa-solid fa-user"></i></div>
                                <div class="textbox">${a.data().content}</div>
                            </div>`;
                    } else {
                        message = `
                            <div class="chat ch1">
                                <div class="icon"><i class="fa-solid fa-user"></i></div>
                                <div class="textbox">${a.data().content}</div>
                            </div>`;
                    }
                $('.chat-content').append(message)
                    })
                    var chatContent = $('.chat-content');
                    chatContent.scrollTop(chatContent.prop("scrollHeight"));
                })
            });
        });

    $('#send').click(function () {
      if (chatroom_id) {
        var chat_data = {
          content: $('#chat-input').val(),
          data: new Date(),
          uid: my_uid,
        };
        db.collection('chat').doc(chatroom_id).collection('message').add(chat_data);

        $('#chat-input').val('');
      }
    });

</script>

</html>