{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <title>마이페이지</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../../static/css/newcom-style.css">
    <link rel="stylesheet" type="text/css" href="../../static/css/mypage-style.css">
    <link rel="canonical" href="https://getbootstrap.kr/docs/5.2/examples/carousel/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://www.googletagmanager.com/gtag/js?l=dataLayer&amp;id=G-7NQSDSFC61" async=""></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% load static %}
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="{% static 'js/firebaseConfig.js' %}"></script>
    <script src="{% static 'js/mypage.js' %}"></script>
</head>

<body>
<header class="p-3 text-bg-dark" style="font-size: 1.4rem;">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">

            <a href="/static" class="d-flex align-items-center mb-2 mb-lg-0 text-black text-decoration-none">
                <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use href="#bootstrap"></use></svg>
            </a>

            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a href="http://127.0.0.1:8000" class="nav-link px-2 text-white">홈</a></li>
                <li><a href="#" class="nav-link px-2 text-white">안내</a></li>
                <li><a href="market.html" class="nav-link px-2 text-white">직거래</a></li>
                <li><a href="auction.html" class="nav-link px-2 text-white">경매장</a></li>
                <li><a href="freeboard.html" class="nav-link px-2 text-white">커뮤니티</a></li>
            </ul>

            <div class="text-end">
                <a id="username" style="text-align: left; font-weight: bold; color: white"></a>
                <a style="font-weight: bold; color: white;">님 환영합니다.</a>
                <button id="mypage" type="button" class="btn btn-primary">마이페이지</button>
                <button type="button" class="btn btn-outline-light me-2" onclick="location.href='login.html'">로그인</button>
                <button id="logout" type="button" class="btn btn-warning">로그아웃</button>
            </div>
        </div>
    </div>
</header>

<div id="face" class="face" style="font-size: 1.4rem; background:none;">
    <div class="face f1">
        <div class="con1">
            <div class="circle">
                <img id="circle-img" src="">
            </div>
            <strong id="name" style="padding-left: 30px; width: 400px; height: 100px; text-align: left; align-items: center; margin-top: 45px; font-size: 3.5rem"></strong>
        </div>
    </div>
    <div class="face f2">

    </div>
    <div class="face f3">
        <div class="con2">
            <a href="#" class="button" onclick="location.href('chatting.html','background-color: #A8C0D6')">채팅방</a>
        </div>
    </div>
</div>
<div class="content-wrapper">
    <div class="bone" style="font-size: 1.4rem">
        <div class="bone b1">
            <div class="info-box" style="height: 500px;">
                <h2 style="padding: 10px;">내가 쓴 글</h2>
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-bs-toggle="tab" style="font-size: 1.4rem"href="#직거래" aria-selected="true" role="tab">직거래</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" style="font-size: 1.4rem" href="#경매장" aria-selected="false" role="tab" tabindex="-1">경매장</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-bs-toggle="tab" style="font-size: 1.4rem" href="#자유게시판" aria-selected="false" role="tab" tabindex="-2">자유게시판</a>
                    </li>
                </ul>
                <div id="myTabContent" class="tab-content">
                    <div class="tab-pane fade active show" id="직거래" role="tabpanel">
                        <div class="container_m">
                            <div class="m_line">

{#                                <div class="m_profile">#}
{#                                    <img src="https://blog.kakaocdn.net/dn/cAI2B2/btrXUq2renL/BTKuB0wwu2L39UKx54Jhw1/img.jpg" alt="">#}
{#                                    <div class="m_details">#}
{#                                        <h2 class="m_title">제목 : 도라에몽</h2>#}
{#                                        <h4 class="m_price">가격 : ????</h4>#}
{#                                        <h4 class="m_date">작성 날짜 : 오늘</h4>#}
{#                                    </div>#}
{#                                </div>#}

                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="경매장" role="tabpanel">
                        <div class="container_ac">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th class="ac_num">번호</th>
                                    <th class="ac_title">제목</th>
                                    <th class="ac_price">입찰 가격</th>
                                    <th class="ac_date">날짜</th>
                                    <th class="ac_count">입찰 목록수</th>
                                </tr>
                                </thead>
                                <tbody class="ac_my_write">

                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="자유게시판" role="tabpanel">
                        <div class="container_fb">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th class="fb_num">번호</th>
                                    <th class="fb_title">제목</th>
                                    <th class="fb_writer">작성자</th>
                                    <th class="fb_date">날짜</th>
                                    <th class="fb_count">조회수</th>
                                </tr>
                                </thead>
                                <tbody class="fb_my_write">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bone b2">
            <div class="content-container">
                <div class="content-a">
                    <div class="info-box" style="height: auto;">
                        <h2 style="padding: 10px">나의 정보</h2>
                        <div class="info-container">
                            <div class="form-group">
                                <label for="name">이름</label>
                                <div class="value" id="myname"></div>
                            </div>
                            <div class="form-group">
                                <label for="age">나이</label>
                                <div class="value" id="myage"></div>
                            </div>
                            <div class="form-group">
                                <label for="jab">직업</label>
                                <div class="value" id="myjob"></div>
                            </div>
                            <div class="form-group">
                                <label for="baN">계좌 번호</label>
                                <div class="value" id="mybaN"></div> <!-- mybaN : my bank account number -->
                            </div>
                            <div class="form-group">
                                <label for="hmA">집 주소</label>
                                <div class="value" id="myhmA"></div> <!-- myhmA : my Home address -->
                            </div>
                            <div class="button-container">
                                <button class="edit-button" onclick="toggleContentB()">수정하기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content-c"> </div>
                <div class="content-b">
                    <div class="info-box" style="height: auto;">
                        <h2 style="padding: 10px">수정 모드</h2>
                        <div class="info-container">
                            <div class="form-group">
                                <label for="name">이름</label>
                                <input type="text" id="username" placeholder="이름을 입력하세요">
                            </div>
                            <div class="form-group">
                                <label for="age">나이</label>
                                <input type="number" id="age" placeholder="나이를 입력하세요">
                            </div>
                            <div class="form-group">
                                <label for="job">직업</label>
                                <input type="text" id="job" placeholder="직업을 입력하세요">
                            </div>
                            <div class="form-group">
                                <label for="upload-image">프로필 사진</label>
                                <div class="file"></div>
                                <input type="file" id="upload-image" name="upload-image" onchange="previewImage(event)">
                            </div>
                            <div class="form-group">
                                <label for="baN">계좌 번호</label>
                                <input type="text" id="baN" placeholder="계좌 번호를 입력하세요">
                            </div>
                            <div class="form-group">
                                <label for="hmA">집 주소</label>
                                <input type="text" id="hmA" placeholder="집 주소를 입력하세요">
                            </div>
                            <div class="button-container">
                                <button class="no-button" onclick="hideContentB()">취소하기</button>
                                <button class="edit-button" id="save">저장하기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer">
        <h3>&nbsp;&nbsp;&nbsp;프로젝트 이름</h3>
        <p>
            &nbsp;호서 대학교
            &nbsp;컴퓨터 공학부&nbsp;
            &nbsp;웹 하자(WebDo) 팀: ㅇㅎㅈ, ㅅㅎㅈ&nbsp;
            &nbsp;이메일 : 추가@바람.com&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&Copyright 2023, All Right Reserved.&nbsp;</spam>
        </p>
    </div>

</body>



<script type='text/javascript'> //random background-color
    var sum = Math.random();
    var result = sum * 10;
    var resultUp = Math.ceil(result);
    var f = document.getElementById('face');
    switch ( resultUp ) {
        case 1 : f.style.background = "#F78181";
            break;
        case 2 : f.style.background = "#FAAC58";
            break;
        case 3 : f.style.background = "#F2F5A9";
            break;
        case 4 : f.style.background = "#BEF781";
            break;
        case 5 : f.style.background = "#81F7F3";
            break;
        case 7 : f.style.background = "#819FF7";
            break;
        case 6 : f.style.background = "#D0A9F5";
            break;
        case 8 : f.style.background = "#F5A9F2";
            break;
        case 9 : f.style.background = "#C0C0C0";
            break;
        default : f.style.background = "#FFD700";
            break;
    }
    // 마이페이지 이동
    $('#mypage').click(function(){
        const auth = firebase.auth();
        const user = auth.currentUser;

        if (user) {
            var uid = user.uid;
            window.location.href = 'http://127.0.0.1:8000/mypage.html?id=' + uid;
        } else {
            // 로그인이 되어 있지 않은 경우, 로그인 페이지로 이동하도록 설정할 수 있습니다.
            window.location.href = 'http://127.0.0.1:8000/login.html';
        }
    });
    // 로그아웃
    document.getElementById('logout').addEventListener('click', (event) => {
      event.preventDefault();

      firebase.auth().signOut()
        .then(() => {
          console.log('User signed out successfully');
          localStorage.removeItem('user');
          location.replace(location.href);
        })
        .catch((error) => {
          console.log('Error signing out:', error);
        });
    });

    function previewImage(event) { //이미지
        var reader = new FileReader();
        reader.onload = function() {
            var image = document.getElementById("circle-img");
            image.src = reader.result;
        }
        reader.readAsDataURL(event.target.files[0]);
    }

    //나의정보 수정하기 클릭시 변경
    var contentA = document.querySelector('.content-a'); //나의정보
    var contentB = document.querySelector('.content-b'); //나의정보 수정모드

    function toggleContentB() { //수정하기 버튼
        contentA.style.display = 'none';
        contentB.style.display = 'block'; //
        /*if (contentB.style.display === 'none') {
            contentB.style.display = 'block';
            contentA.style.display = 'none';
        } else {
            contentB.style.display = 'none';
            contentA.style.display = 'block';
        }*/
        contentA.style.width = '0';
        contentB.style.width = '100%';
    }

    function hideContentB() {
        contentA.style.display = 'block';
        contentB.style.display = 'none';
        contentA.style.width = '100%';
        contentB.style.width = '0';
    }

    // 채팅방 이동
    $('.button').click(function() {
        window.location.href = 'http://127.0.0.1:8000/chatting.html?id=' + my_uid;
    });


    // 프로필 및 개인정보 변경
    $('#save').click(function () {
        var file = document.querySelector('#upload-image').files[0];
        var storageRef = storage.ref();
        var save_img = null;
        var upload_img = null;
        var url = null;

        if (file) {
            save_img = storageRef.child('/image/' + file.name);
            upload_img = save_img.put(file)
            upload_img.on('state_change',
                null,
                (error) => {
                    console.error('실패', error);
                },
                () => {
                    upload_img.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        url = downloadURL;
                        console.log('업로드된 경로', url)

                        var today = new Date();
                        var month = today.getMonth() + 1;
                        var day = today.getDate();

                        var img = {
                            nickname: $('#username').val(),
                            age: $('#age').val(),
                            job: $('#job').val(),
                            ban: $('#baN').val(),
                            hma: $('#hmA').val(),
                            수정날짜: month + "월 " + day + "일",
                            이미지: url,
                        }
                        db.collection('user').doc(my_uid).update(img)
                            .then((result) => {
                                console.log(result);
                                location.replace(location.href);
                            }).catch((error) => {
                                console.log(error)
                            });
                    });
                }
            );
        } else {
            saveData();
        }

        function saveData() {
            var today = new Date();
            var month = today.getMonth() + 1;
            var day = today.getDate();

            var save_txt = {
                nickname: $('#username').val(),
                age: $('#age').val(),
                job: $('#job').val(),
                ban: $('#baN').val(),
                hma: $('#hmA').val(),
                수정날짜: month + "월 " + day + "일",
            };
            db.collection('user').doc(my_uid).update(save_txt)
                .then((result) => {
                    console.log(result);
                    location.replace(location.href);
                }).catch((error) => {
                    console.log(error)
                });
        }
    });

</script>
</html>