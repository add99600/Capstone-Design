{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <title>마이페이지</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="./static/css/newcom-style.css">
    <link rel="stylesheet" type="text/css" href="./static/css/mypage-style.css">
    <link rel="canonical" href="https://getbootstrap.kr/docs/5.2/examples/carousel/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://www.googletagmanager.com/gtag/js?l=dataLayer&amp;id=G-7NQSDSFC61" async=""></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<header class="p-3 text-bg-dark" style="font-size: 1.4rem;">
    <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
            <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap"><use xlink:href="#bootstrap"></use></svg>
            </a>

            <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                <li><a href="http://127.0.0.1:8000" class="nav-link px-2 text-white">홈</a></li>
                <li><a href="#" class="nav-link px-2 text-white">안내</a></li>
                <li><a href="#" class="nav-link px-2 text-white">공지사항</a></li>
                <li><a href="market.html" class="nav-link px-2 text-white">직거래</a></li>
                <li><a href="freeboard.html" class="nav-link px-2 text-white">커뮤니티</a></li>
            </ul>

            <form class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3" role="search">
                <input type="search" class="form-control form-control-dark text-bg-dark" placeholder="Search..." aria-label="Search">
            </form>

            <div class="text-end" style="font-size: 1.4rem;">
                <button type="button" class="btn btn-outline-light me-2" onclick="location.href='login.html'">로그인</button>
                <button type="button" class="btn btn-warning" onclick="location.href='jtm.html'">회원가입</button>
                <button type="button" class="btn btn-primary" onclick="location.href='mypage.html'">마이페이지</button>
            </div>
        </div>
    </div>
</header>


<div class="face" style="font-size: 1.4rem">
    <div class="face f1">
        <div class="circle">
            <img id="circle-img" src="">
        </div>
    </div>
    <div class="face f2"> </div>
    <div class="face f3">
        <a href="#" class="button">채팅방</a>
    </div>
</div>
<div class="content-wrapper">
    <div class="bone" style="font-size: 1.4rem">
        <div class="bone b1">
            <div class="info-box">
                <h2 style="padding: 10px">- 내가 쓴 글</h2>
                <form>
                    <div class="my_write">
                    </div>
                </form>
            </div>
        </div>
        <div class="bone b2">
            <div class="info-box">
                <h2 style="padding: 10px">- 프로필 사진 설정</h2>
                <form style="padding: 10px">
                    <input type="file" accept="image/*" onchange="readURL(this);">
                    <br>
                    <button style="margin: 5px;" id="send">저장</button>
                </form>
            </div>
            <div class="info-box">
                <h2 style="padding: 10px">- 나의 정보</h2>
                <form style="padding: 10px">
                    <label for="name">이름:</label>
                    <input type="text" id="name" name="name"><br><br>
                    <label for="age">나이:</label>
                    <input type="text" id="age" name="age"><br><br>
                    <label for="job">직업:</label>
                    <input type="text" id="job" name="job"><br><br>
                    <label for="email">이메일:</label>
                    <input type="text" id="email" name="email"><br><br>
                    <input type="submit" value="Submit">
                </form>
            </div>
        </div>
    </div>
</div>
<div class="footer">
        <h3>&nbsp;&nbsp;&nbsp;프로젝트 이름</h3>
        <p>
            &nbsp;호서 대학교
            &nbsp;컴퓨터 공학부&nbsp;
            &nbsp;웹 하자(WebDo) 팀: ㅇㅎㅈ, ㅅㅎㅈ&nbsp;
            &nbsp;이메일 : 추가@바람.com&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&Copyright 2023, All Right Reserved.&nbsp;</spam>
        </p>
    </div>

</body>


<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
<script>
    function readURL(input) { //이미지
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('circle-img').src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    var firebaseConfig = {
        apiKey: "AIzaSyCunQjLi23bBAybA97IFMaIrXUwuJSV8mM",
        authDomain: "wepdo-7bed1.firebaseapp.com",
        databaseURL: "https://wepdo-7bed1-default-rtdb.firebaseio.com",
        projectId: "wepdo-7bed1",
        storageBucket: "wepdo-7bed1.appspot.com",
        messagingSenderId: "204948006692",
        appId: "1:204948006692:web:bbb863d7032ddbbf64b5b1",
        measurementId: "G-7NQSDSFC61"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    const user = auth.currentUser;

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log(user.uid);
        }
    });

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get('id');

    db.collection('product')
      .where('uid', '==', user)
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          // do something with the document
        });
      })
      .catch((error) => {
        console.log('Error getting documents: ', error);
      });


    $('#send').click(function () {

        var file = document.querySelector('#image').files[0];
        var storageRef = storage.ref();
        var save_img = null;
        var upload_img = null;
        var url = null;

        const auth = firebase.auth();
        const user = auth.currentUser;

        if (file) {
            save_img = storageRef.child('/image/' + file.name);
            upload_img = save_img.put(file)
            upload_img.on('state_change',
                null,
                (error) => {
                    console.error('실패',error);
                },
                () => {
                    upload_img.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        url = downloadURL;
                        console.log('업로드된 경로',url)

                        var today = new Date();
                        var month = today.getMonth() + 1;
                        var day = today.getDate();

                        var img = {
                            날짜: month + "월 " + day + "일",
                            uid: user.uid,
                            이미지: url,
                        }
                        db.collection('profile').add(img)
                            .then((result) => {
                                console.log(result)
                            }).catch((error) => {
                            console.log(error)
                        })
                    });
                }
            )
        }
    });

    var bring = new URLSearchParams(window.location.search)

    db.collection('profile').get().then((doc) => {
        if (doc.exists) {
            console.log(doc.data());
            $('.circle').html(doc.data().이미지);
        } else {
            console.log("No such document");
        }
    });

</script>
</html>